<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bot Command Safety Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #050816;
      color: #f5f5f5;
    }
    h1, h2 {
      margin: 0 0 .75rem 0;
    }
    .card {
      background: #0b1020;
      border-radius: 8px;
      padding: 1rem 1.25rem;
      margin-bottom: 1rem;
      border: 1px solid rgba(255,255,255,0.08);
    }
    label {
      display: inline-block;
      margin-bottom: .25rem;
    }
    textarea {
      width: 100%;
      min-height: 160px;
      background: #050816;
      color: #f5f5f5;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.15);
      padding: .5rem;
      font-family: ui-monospace, monospace;
      font-size: .85rem;
      white-space: pre;
    }
    button {
      margin-top: .6rem;
      padding: .45rem .9rem;
      border-radius: 4px;
      border: none;
      background: #2563eb;
      color: #f5f5f5;
      font-weight: 500;
      cursor: pointer;
    }
    button:disabled {
      opacity: .6;
      cursor: default;
    }
    .small {
      font-size: .8rem;
      opacity: .85;
    }
    .badge {
      display: inline-block;
      padding: .1rem .45rem;
      border-radius: 999px;
      font-size: .7rem;
      margin-right: .4rem;
    }
    .critical { background: #b91c1c; }
    .high { background: #ea580c; }
    .medium { background: #ca8a04; }
    .info { background: #1d4ed8; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: .5rem;
      font-size: .85rem;
    }
    th, td {
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding: .4rem;
      vertical-align: top;
    }
    th {
      background: rgba(15,23,42,0.8);
      text-align: left;
      font-weight: 600;
    }
    code {
      font-family: ui-monospace, monospace;
      font-size: .8rem;
      background: rgba(15,23,42,0.9);
      padding: .05rem .2rem;
      border-radius: 3px;
    }
  </style>
</head>
<body>

  <div class="card">
    <h1>Bot Command Safety Checker</h1>
    <p class="small">
      Paste your StreamElements and Nightbot command pages. This page detects dangerous patterns
      like command injection, URL hijacking, eval abuse, and unsafe dynamic responses.
      All processing happens locally in your browser.
    </p>
  </div>

  <div class="card">
    <h2>StreamElements</h2>
    <p class="small">Copy the full custom commands table and paste it below.</p>
    <label for="seInput">StreamElements commands</label>
    <textarea id="seInput"></textarea>
  </div>

  <div class="card">
    <h2>Nightbot</h2>
    <p class="small">Copy the entire commands page (Ctrl+A, Ctrl+C) and paste it below.</p>
    <label for="nbInput">Nightbot commands</label>
    <textarea id="nbInput"></textarea>
  </div>

  <div class="card">
    <h2>Analyze</h2>
    <button id="scanBtn">Scan</button>
    <div id="status" class="small" style="margin-top:.4rem;"></div>
  </div>

  <div id="resultsCard" class="card" style="display:none;">
    <h2>Results</h2>
    <div id="resultsBody"></div>
  </div>

<script>
  const scanBtn = document.getElementById('scanBtn');
  const statusEl = document.getElementById('status');
  const resultsCard = document.getElementById('resultsCard');
  const resultsBody = document.getElementById('resultsBody');

  scanBtn.addEventListener('click', () => {
    statusEl.textContent = 'Analyzing...';
    const seText = document.getElementById('seInput').value || '';
    const nbText = document.getElementById('nbInput').value || '';
    const commands = [];
    if (seText.trim()) commands.push(...parseTabbedCommands(seText, 'streamelements'));
    if (nbText.trim()) commands.push(...parseNightbotText(nbText));
    if (!commands.length) {
      statusEl.textContent = 'No commands detected.';
      resultsCard.style.display = 'none';
      return;
    }
    const analyzed = analyzeAll(commands);
    renderResults(analyzed);
    resultsCard.style.display = 'block';
    statusEl.textContent = 'Done.';
  });

  function parseTabbedCommands(text, provider) {
    const cmds = [];
    const lines = text.split(/\r?\n/);
    for (const raw of lines) {
      if (!raw.trim()) continue;
      const parts = raw.split('\t');
      if (parts.length < 3) continue;
      if (parts[0].trim().toLowerCase() === 'command') continue;
      if (!parts[0].trim().startsWith('!')) continue;
      cmds.push({
        provider,
        name: parts[0].trim(),
        accessLevel: parts[1].trim(),
        response: parts[2].trim()
      });
    }
    return cmds;
  }

  function parseNightbotText(text) {
    const cmds = [];
    const lines = text.split(/\r?\n/);
    let current = null;
    const isPerm = l => /^(everyone|moderator|owner|regular|subscribers?|vip)/i.test(l);
    const ignore = l =>
      /^nightbot$/i.test(l) ||
      /commands are used/i.test(l) ||
      /^search commands/i.test(l) ||
      /^show\s+\d+/i.test(l) ||
      /^page\s+\d+/i.test(l) ||
      /^copyright/i.test(l) ||
      /terms of service/i.test(l) ||
      /privacy policy/i.test(l) ||
      /api documentation/i.test(l);

    for (const raw of lines) {
      const line = raw.trim();
      if (!line || ignore(line)) continue;
      if (line.startsWith('!')) {
        if (current && current.name && current.permission) {
          cmds.push({
            provider: 'nightbot',
            name: current.name,
            accessLevel: current.permission,
            response: current.response.trim()
          });
        }
        current = { name: line, response: '', permission: '' };
        continue;
      }
      if (current && isPerm(line)) {
        current.permission = line;
        continue;
      }
      if (current) {
        if (current.response) current.response += ' ';
        current.response += line;
      }
    }

    if (current && current.name && current.permission) {
      cmds.push({
        provider: 'nightbot',
        name: current.name,
        accessLevel: current.permission,
        response: current.response.trim()
      });
    }
    return cmds;
  }

  function analyzeAll(commands) {
    return commands.map(cmd => ({ ...cmd, issues: analyze(cmd) }));
  }

  function analyze(cmd) {
    const issues = [];
    const resp = cmd.response || '';
    const access = (cmd.accessLevel || '').toLowerCase();
    const isPublic =
      access.includes('everyone') ||
      access.includes('regular') ||
      access.includes('all');

    if (cmd.provider === 'streamelements') {
      if (isPublic && /^[\s]*\$\((args|1|touser|sender\.lastmessage|user\.lastmessage)/i.test(resp)) {
        issues.push({
          severity: 'Critical',
          type: 'TwitchCommandInjection',
          message: 'Response begins with user-controlled text.',
          fix: 'Add static text before variables or restrict to mods.'
        });
      }
      if (/\$\(set(title|game)/i.test(resp) &&
          /\$\((args|1|touser|sender\.lastmessage|user\.lastmessage)/i.test(resp)) {
        issues.push({
          severity: isPublic ? 'High' : 'Medium',
          type: 'MetadataHijack',
          message: 'User input used in $(settitle) or $(setgame).',
          fix: 'Restrict to mods and avoid passing raw arguments.'
        });
      }
      if (/\$\(customapi|\$\(urlfetch/i.test(resp) &&
          (/\$\((args|1|touser)/i.test(resp) || /\$\{1:/i.test(resp))) {
        issues.push({
          severity: 'High',
          type: 'ExternalRequestInjection',
          message: 'User input flows into external fetch.',
          fix: 'Use fixed URLs with encoded parameters.'
        });
      }
      if (/\$\(ai/i.test(resp) &&
          /\$\((args|1|touser|sender\.lastmessage|user\.lastmessage)/i.test(resp)) {
        issues.push({
          severity: 'Medium',
          type: 'AIPromptControl',
          message: 'User input feeds AI prompt.',
          fix: 'Limit input scope.'
        });
      }
      if (/\$\(repeat/i.test(resp) &&
          /\$\((args|1|touser|sender\.lastmessage|user\.lastmessage)/i.test(resp)) {
        issues.push({
          severity: 'Medium',
          type: 'SpamAmplifier',
          message: '$(repeat) used with untrusted input.',
          fix: 'Avoid repeating raw viewer input.'
        });
      }
    }

    if (cmd.provider === 'nightbot') {
      if (isPublic && /^[\s]*\$\((query|querystring|[0-9]|touser)/i.test(resp)) {
        issues.push({
          severity: 'Critical',
          type: 'TwitchCommandInjection',
          message: 'Response begins with $(query) or $(1).',
          fix: 'Add static prefixes or restrict to mods.'
        });
      }
      if (/\$\(eval/i.test(resp) && /\$\((query|querystring|[0-9])/i.test(resp)) {
        issues.push({
          severity: 'High',
          type: 'EvalInjection',
          message: 'User input reaches $(eval).',
          fix: 'Avoid eval on raw user input.'
        });
      }
      if (/\$\(urlfetch/i.test(resp) && /\$\((query|querystring)/i.test(resp)) {
        issues.push({
          severity: 'High',
          type: 'ExternalRequestInjection',
          message: 'User influences urlfetch URL.',
          fix: 'Use fixed URLs and encoded parameters.'
        });
      }
    }

    return issues;
  }

  function renderResults(commands) {
    const rows = [];
    commands.forEach(cmd => {
      if (!cmd.issues.length) return;
      cmd.issues.forEach(issue => {
        const cls = issue.severity.toLowerCase();
        rows.push(`
          <tr>
            <td>${escape(cmd.provider)}</td>
            <td><code>${escape(cmd.name)}</code></td>
            <td>${escape(cmd.accessLevel)}</td>
            <td><span class="badge ${cls}">${issue.severity}</span><br><span class="small">${escape(issue.type)}</span></td>
            <td>
              <div class="small">${escape(issue.message)}</div>
              <div class="small" style="margin-top:.25rem;"><strong>Fix:</strong> ${escape(issue.fix)}</div>
              <div class="small" style="margin-top:.25rem;"><strong>Response:</strong> <code>${escape(shorten(cmd.response,160))}</code></div>
            </td>
          </tr>
        `);
      });
    });
    if (!rows.length) {
      resultsBody.innerHTML =
        `<p>No major risks detected.</p><p class="small">Still review commands that echo user input.</p>`;
      return;
    }
    resultsBody.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Provider</th>
            <th>Command</th>
            <th>Access</th>
            <th>Risk</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>${rows.join('')}</tbody>
      </table>
    `;
  }

  function escape(str) {
    return (str || '').replace(/[&<>"'`]/g, s => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;',
      '"': '&quot;', "'": '&#39;', '`': '&#96;'
    }[s]));
  }

  function shorten(str, max) {
    return (!str || str.length <= max) ? str : str.slice(0, max) + 'â€¦';
  }
</script>

</body>
</html>
